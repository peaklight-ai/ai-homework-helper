---
phase: 01-sprint-1-teacher-experience
plan: 04
type: execute
wave: 3
depends_on: [01-02, 01-03]
files_modified:
  - app/teacher/page.tsx
  - components/CreateClassModal.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher dashboard shows class selector dropdown"
    - "Teacher can create new class via modal"
    - "Selecting a class filters student list to that class only"
    - "CSV import button appears when class is selected"
    - "Students added show in correct class"
  artifacts:
    - path: "app/teacher/page.tsx"
      provides: "Updated dashboard with class-scoped student view"
      contains: "ClassSelector"
    - path: "components/CreateClassModal.tsx"
      provides: "Modal for creating new class"
      min_lines: 50
  key_links:
    - from: "app/teacher/page.tsx"
      to: "components/ClassSelector.tsx"
      via: "import and render"
      pattern: "import.*ClassSelector"
    - from: "app/teacher/page.tsx"
      to: "/api/classes"
      via: "fetch"
      pattern: "fetch.*api/classes"
---

<objective>
Integrate class management into teacher dashboard with class-scoped student views.

Purpose: Enable teachers to view students organized by class instead of a flat mixed list.
Output: Updated teacher dashboard with class selector, create class modal, and class-filtered student view.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-sprint-1-teacher-experience/01-02-SUMMARY.md
@.planning/phases/01-sprint-1-teacher-experience/01-03-SUMMARY.md

Key existing files:
@app/teacher/page.tsx (main file to modify)
@components/ClassSelector.tsx (from Plan 03)
@components/CSVImportModal.tsx (from Plan 03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CreateClassModal component</name>
  <files>components/CreateClassModal.tsx</files>
  <action>
Create `components/CreateClassModal.tsx`:
```typescript
'use client'

import { useState } from 'react'
import { motion } from 'framer-motion'

interface CreateClassModalProps {
  teacherId: string
  onClose: () => void
  onClassCreated: () => void
}

export function CreateClassModal({
  teacherId,
  onClose,
  onClassCreated
}: CreateClassModalProps) {
  const [name, setName] = useState('')
  const [grade, setGrade] = useState<number | ''>('')
  const [isCreating, setIsCreating] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const handleCreate = async () => {
    if (!name.trim()) return

    setIsCreating(true)
    setError(null)

    try {
      const response = await fetch('/api/classes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          teacherId,
          name: name.trim(),
          grade: grade || null
        })
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'Failed to create class')
      }

      onClassCreated()
      onClose()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to create class')
    } finally {
      setIsCreating(false)
    }
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <motion.div
        className="w-full max-w-md mx-4 rounded-xl p-6"
        style={{ backgroundColor: '#0F172A', border: '1px solid #1E293B' }}
        initial={{ opacity: 0, scale: 0.9 }}
        animate={{ opacity: 1, scale: 1 }}
      >
        <h2 className="text-xl font-bold mb-4" style={{ color: '#F9FAFB' }}>
          Create New Class
        </h2>

        {error && (
          <div
            className="mb-4 p-3 rounded-lg"
            style={{ backgroundColor: 'rgba(251, 113, 133, 0.1)', border: '1px solid #FB7185' }}
          >
            <p style={{ color: '#FB7185' }}>{error}</p>
          </div>
        )}

        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1" style={{ color: '#94A3B8' }}>
              Class Name *
            </label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="e.g., Math 3A, Grade 4 Blue"
              className="w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2"
              style={{ backgroundColor: '#1E293B', color: '#F9FAFB', border: '1px solid #64748B' }}
              autoFocus
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1" style={{ color: '#94A3B8' }}>
              Grade Level (optional)
            </label>
            <select
              value={grade}
              onChange={(e) => setGrade(e.target.value ? parseInt(e.target.value) : '')}
              className="w-full px-3 py-2 rounded-lg focus:outline-none"
              style={{ backgroundColor: '#1E293B', color: '#F9FAFB', border: '1px solid #64748B' }}
            >
              <option value="">Select grade...</option>
              {[1, 2, 3, 4, 5, 6].map(g => (
                <option key={g} value={g}>Grade {g}</option>
              ))}
            </select>
          </div>
        </div>

        <div className="flex gap-3 mt-6">
          <button
            onClick={onClose}
            className="flex-1 py-2 rounded-lg font-medium"
            style={{ backgroundColor: '#1E293B', color: '#94A3B8' }}
          >
            Cancel
          </button>
          <button
            onClick={handleCreate}
            disabled={!name.trim() || isCreating}
            className="flex-1 py-2 rounded-lg font-medium disabled:opacity-50"
            style={{ backgroundColor: '#38BDF8', color: '#020617' }}
          >
            {isCreating ? 'Creating...' : 'Create Class'}
          </button>
        </div>
      </motion.div>
    </div>
  )
}
```
  </action>
  <verify>
1. `npm run build` - no errors
2. File exists: components/CreateClassModal.tsx
  </verify>
  <done>CreateClassModal component created with name and optional grade fields</done>
</task>

<task type="auto">
  <name>Task 2: Integrate class management into teacher dashboard</name>
  <files>app/teacher/page.tsx</files>
  <action>
Modify `app/teacher/page.tsx` to add class-scoped student view.

**Add imports at top:**
```typescript
import { ClassSelector } from '@/components/ClassSelector'
import { CreateClassModal } from '@/components/CreateClassModal'
import { CSVImportModal } from '@/components/CSVImportModal'
import { ClassWithStudents } from '@/lib/supabase'
```

**Add state variables (after existing state declarations around line 45-63):**
```typescript
// Class management
const [classes, setClasses] = useState<ClassWithStudents[]>([])
const [selectedClassId, setSelectedClassId] = useState<string | null>(null)
const [showCreateClass, setShowCreateClass] = useState(false)
const [showImportCSV, setShowImportCSV] = useState(false)
```

**Add fetchClasses function (after fetchStudents around line 89):**
```typescript
const fetchClasses = useCallback(async () => {
  if (!user) return

  try {
    const response = await fetch('/api/classes', {
      headers: { 'x-teacher-id': user.id }
    })

    if (response.ok) {
      const data = await response.json()
      setClasses(data.classes || [])
    }
  } catch (err) {
    console.error('Error fetching classes:', err)
  }
}, [user])
```

**Update useEffect to fetch classes (around line 91-95):**
```typescript
useEffect(() => {
  if (user) {
    fetchStudents()
    fetchClasses()
  }
}, [user, fetchStudents, fetchClasses])
```

**Add filtered students computed value (before return statement):**
```typescript
// Filter students by selected class
const filteredStudents = selectedClassId
  ? classes.find(c => c.id === selectedClassId)?.students || []
  : students

const selectedClass = classes.find(c => c.id === selectedClassId)
```

**In the Student List section (around line 388-521), add ClassSelector above the student list heading:**

Replace the `<h2>Students</h2>` section with:
```tsx
{/* Class Selector */}
<ClassSelector
  classes={classes}
  selectedClassId={selectedClassId}
  onSelectClass={setSelectedClassId}
  onCreateClass={() => setShowCreateClass(true)}
/>

<div className="flex items-center justify-between mb-4">
  <h2 className="text-lg font-bold" style={{ color: '#F9FAFB' }}>
    {selectedClassId ? selectedClass?.name : 'All Students'}
  </h2>
  <div className="flex gap-2">
    {selectedClassId && (
      <button
        onClick={() => setShowImportCSV(true)}
        className="px-3 py-1 rounded-lg text-sm font-medium transition-all hover:scale-105"
        style={{ backgroundColor: '#22C55E', color: '#020617' }}
      >
        Import CSV
      </button>
    )}
    <button
      onClick={() => setShowAddStudent(!showAddStudent)}
      className="w-8 h-8 rounded-lg flex items-center justify-center transition-all hover:scale-110"
      style={{ backgroundColor: '#38BDF8', color: '#020617' }}
    >
      ...existing icon...
    </button>
  </div>
</div>
```

**Update the student list to use filteredStudents:**
Replace `students.map((student) =>` with `filteredStudents.map((student) =>`

Also update these references:
- `students.length === 0` -> `filteredStudents.length === 0`
- Empty state message: update to mention selecting a class or adding students

**Add modals before the closing `</div>` of the main component (after settings modal, around line 765):**
```tsx
{/* Create Class Modal */}
{showCreateClass && user && (
  <CreateClassModal
    teacherId={user.id}
    onClose={() => setShowCreateClass(false)}
    onClassCreated={() => {
      fetchClasses()
      fetchStudents()
    }}
  />
)}

{/* CSV Import Modal */}
{showImportCSV && selectedClass && (
  <CSVImportModal
    classId={selectedClass.id}
    className={selectedClass.name}
    onClose={() => setShowImportCSV(false)}
    onImportComplete={() => {
      fetchClasses()
      fetchStudents()
    }}
  />
)}
```

**Update class stats to reflect filtered view (around line 205-211):**
```typescript
const displayStudents = filteredStudents
const totalStudents = displayStudents.length
const totalXP = displayStudents.reduce((sum, s) => sum + s.progress.totalXp, 0)
const totalCorrect = displayStudents.reduce((sum, s) => sum + s.progress.correctAnswers, 0)
const totalQuestions = displayStudents.reduce((sum, s) => sum + s.progress.totalQuestions, 0)
const studentsAtGoal = displayStudents.filter(s => s.progress.totalXp >= xpGoal).length
```
  </action>
  <verify>
1. `npm run build` - no errors
2. Start dev server: `npm run dev`
3. Navigate to /teacher
4. Verify: Class selector dropdown visible
5. Verify: "+ Class" button opens create class modal
6. Verify: Creating a class adds it to dropdown
7. Verify: Selecting a class filters student list
8. Verify: "Import CSV" button appears when class selected
  </verify>
  <done>Teacher dashboard integrated with class selector, create class modal, and class-filtered student view</done>
</task>

<task type="auto">
  <name>Task 3: Wire up student creation to selected class</name>
  <files>app/teacher/page.tsx</files>
  <action>
Update the `handleAddStudent` function to automatically enroll new students in the selected class.

**Find handleAddStudent function (around line 111-139) and modify:**
```typescript
const handleAddStudent = async () => {
  if (!newStudentName.trim() || !user) return

  setIsAdding(true)
  try {
    // Create student
    const response = await fetch('/api/students', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        teacherId: user.id,
        name: newStudentName.trim(),
        grade: newStudentGrade
      })
    })

    if (!response.ok) {
      throw new Error('Failed to create student')
    }

    const data = await response.json()

    // If a class is selected, enroll student in that class
    if (selectedClassId && data.student?.id) {
      await fetch(`/api/classes/${selectedClassId}/students`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ studentId: data.student.id })
      })
    }

    // Refresh lists
    await fetchStudents()
    await fetchClasses()
    setNewStudentName('')
    setShowAddStudent(false)
  } catch (err) {
    console.error('Error adding student:', err)
    setError('Failed to add student')
  } finally {
    setIsAdding(false)
  }
}
```

**Update the add student form placeholder text to reflect class context:**
In the add student form section, update the placeholder:
```tsx
<input
  type="text"
  placeholder={selectedClassId ? `Student name (adding to ${selectedClass?.name})` : "Student name"}
  ...
/>
```
  </action>
  <verify>
1. `npm run build` - no errors
2. Test: Select a class, add a student, verify student appears in that class
3. Test: With "All Students" selected, add student, verify student created (not in any class)
  </verify>
  <done>New students automatically enrolled in selected class when created</done>
</task>

</tasks>

<verification>
- [ ] CreateClassModal component exists and works
- [ ] Teacher dashboard shows ClassSelector dropdown
- [ ] Creating class via modal adds it to dropdown
- [ ] Selecting class filters student list to that class only
- [ ] "Import CSV" button visible when class selected
- [ ] New students added to selected class
- [ ] Stats update based on filtered view
- [ ] Build passes: `npm run build`
</verification>

<success_criteria>
1. Teacher can create classes and see them in dropdown
2. Selecting a class shows only students in that class
3. CSV import button appears when class is selected
4. Adding a student while class is selected enrolls them in that class
5. CLASS-02 requirement satisfied: Students organized by class, not mixed list
</success_criteria>

<output>
After completion, create `.planning/phases/01-sprint-1-teacher-experience/01-04-SUMMARY.md`
</output>
