---
phase: 01-sprint-1-teacher-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/gemini.ts
  - supabase/migrations/001_classes.sql
autonomous: false

must_haves:
  truths:
    - "AI celebrates and stops after correct answer without follow-up questions"
    - "Classes and class_students tables exist in Supabase"
    - "Emails sent from Supabase arrive in inbox (not junk)"
  artifacts:
    - path: "lib/gemini.ts"
      provides: "Updated system prompt with stronger completion rule"
      contains: "COMPLETION RULE"
    - path: "supabase/migrations/001_classes.sql"
      provides: "Database schema for classes and class_students"
      contains: "CREATE TABLE classes"
  key_links:
    - from: "lib/gemini.ts"
      to: "AI response behavior"
      via: "system prompt rules"
      pattern: "COMPLETION RULE.*HIGHEST PRIORITY"
---

<objective>
Fix critical bugs and create database foundation for class management.

Purpose: Clear blockers (BUG-01, BUG-02) and establish schema required by all subsequent plans.
Output: Working AI completion behavior, database tables for classes, and configured email delivery.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-sprint-1-teacher-experience/01-RESEARCH.md

Key existing files:
@lib/gemini.ts (system prompt location - line 30-46)
@lib/supabase.ts (database types and functions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix AI follow-up after correct answer (BUG-01)</name>
  <files>lib/gemini.ts</files>
  <action>
Modify the system prompt in getSocraticResponseStream() to add a stronger completion rule.

Current rule (line 41):
```
9. IMPORTANT: When the student gives the CORRECT final answer...
```

Replace with stronger rule (keep it minimal - no prompt bloat):
```
9. COMPLETION RULE (HIGHEST PRIORITY): When the student gives the CORRECT final answer (${context.problemAnswer}), respond with ONLY a celebration like "Well done!" or "Great job!". NO follow-up questions. NO asking them to explain. Just celebrate briefly and STOP.
```

This is 2 sentences more specific than the original, not verbose. The key changes:
- "HIGHEST PRIORITY" signals precedence over other rules
- Explicit "NO" statements for what not to do
- "STOP" as final instruction
  </action>
  <verify>
1. Run `npm run build` - no errors
2. Manual test: Start conversation, give correct answer, AI should celebrate only without follow-up questions
  </verify>
  <done>AI responds with brief celebration and no follow-up when student gives correct answer</done>
</task>

<task type="auto">
  <name>Task 2: Create classes database schema</name>
  <files>supabase/migrations/001_classes.sql</files>
  <action>
Create SQL migration file with the schema from research document (minimal - only what's needed):

```sql
-- Classes table
CREATE TABLE IF NOT EXISTS classes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  teacher_id UUID REFERENCES teachers(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  grade INTEGER CHECK (grade BETWEEN 1 AND 6),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_classes_teacher ON classes(teacher_id);

-- Class-student junction table (allows students in multiple classes)
CREATE TABLE IF NOT EXISTS class_students (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  class_id UUID REFERENCES classes(id) ON DELETE CASCADE NOT NULL,
  student_id UUID REFERENCES students(id) ON DELETE CASCADE NOT NULL,
  enrolled_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(class_id, student_id)
);

CREATE INDEX idx_class_students_class ON class_students(class_id);
CREATE INDEX idx_class_students_student ON class_students(student_id);

-- RLS Policies
ALTER TABLE classes ENABLE ROW LEVEL SECURITY;
ALTER TABLE class_students ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Teachers manage own classes" ON classes
  FOR ALL USING (teacher_id = auth.uid());

CREATE POLICY "Service role bypass classes" ON classes
  FOR ALL USING (auth.jwt()->>'role' = 'service_role');

CREATE POLICY "Teachers manage class enrollments" ON class_students
  FOR ALL USING (
    class_id IN (SELECT id FROM classes WHERE teacher_id = auth.uid())
  );

CREATE POLICY "Service role bypass class_students" ON class_students
  FOR ALL USING (auth.jwt()->>'role' = 'service_role');
```

Note: Intentionally omitted `description`, `school_year`, `status`, `updated_at` columns to keep schema minimal per user constraint.
  </action>
  <verify>
Run migration in Supabase:
1. Go to Supabase Dashboard > SQL Editor
2. Paste and run the migration
3. Verify tables appear in Table Editor: `classes`, `class_students`
  </verify>
  <done>classes and class_students tables exist in Supabase with proper indexes and RLS</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Configure Resend SMTP for email delivery (BUG-02)</name>
  <action>
This requires human dashboard configuration. Claude cannot access Supabase Dashboard or Resend Dashboard.
  </action>
  <instructions>
**Steps to fix email going to junk:**

1. **Create Resend account** (free tier: 3,000 emails/month)
   - Go to https://resend.com
   - Sign up with your email

2. **Verify your domain in Resend**
   - Resend Dashboard > Domains > Add Domain
   - Add DNS records (SPF, DKIM, DMARC) to your domain registrar
   - Wait for verification (usually minutes)

3. **Get Resend API key**
   - Resend Dashboard > API Keys > Create API Key
   - Copy the key (starts with `re_`)

4. **Configure Supabase SMTP**
   - Supabase Dashboard > Project Settings > Auth > SMTP Settings
   - Enable "Custom SMTP"
   - Enter:
     - Host: `smtp.resend.com`
     - Port: `465`
     - Username: `resend`
     - Password: [Your Resend API key]
     - Sender email: `noreply@yourdomain.com`

5. **Test email delivery**
   - Go to your app's signup page
   - Sign up with a new email
   - Verify email arrives in inbox (not spam)

If you don't have a custom domain, skip this task for now - default Supabase emails work, just may go to spam. Mark as "skipped" in summary.
  </instructions>
  <resume-signal>Type "email configured" when done, or "skipped" if no custom domain</resume-signal>
</task>

</tasks>

<verification>
- [ ] BUG-01: AI celebrates without follow-up on correct answer
- [ ] Database: `classes` table exists with teacher_id, name, grade columns
- [ ] Database: `class_students` table exists with class_id, student_id columns
- [ ] BUG-02: Test email arrives in inbox (or marked skipped)
- [ ] Build passes: `npm run build`
</verification>

<success_criteria>
1. System prompt updated - build passes
2. Database migration applied - tables visible in Supabase
3. Email configuration complete (or consciously skipped)
</success_criteria>

<output>
After completion, create `.planning/phases/01-sprint-1-teacher-experience/01-01-SUMMARY.md`
</output>
