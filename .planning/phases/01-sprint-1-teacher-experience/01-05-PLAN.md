---
phase: 01-sprint-1-teacher-experience
plan: 05
type: execute
wave: 3
depends_on: [01-02]
files_modified:
  - supabase/migrations/002_exercises.sql
  - lib/supabase.ts
  - app/api/exercises/route.ts
  - app/api/exercises/assign/route.ts
autonomous: true

must_haves:
  truths:
    - "Teacher can create exercises with question, answer, and difficulty"
    - "Teacher can assign exercises to a class (all students)"
    - "Teacher can assign exercises to specific students"
    - "Assignments can have optional due date"
  artifacts:
    - path: "supabase/migrations/002_exercises.sql"
      provides: "exercises and exercise_assignments tables"
      contains: "CREATE TABLE exercises"
    - path: "lib/supabase.ts"
      provides: "Exercise types and CRUD functions"
      contains: "interface Exercise"
    - path: "app/api/exercises/route.ts"
      provides: "GET (list) and POST (create) exercise endpoints"
      exports: ["GET", "POST"]
    - path: "app/api/exercises/assign/route.ts"
      provides: "POST endpoint for assigning exercises"
      exports: ["POST"]
  key_links:
    - from: "app/api/exercises/assign/route.ts"
      to: "exercise_assignments table"
      via: "Supabase client"
      pattern: "from\\('exercise_assignments'\\)"
---

<objective>
Build exercise creation and assignment system for homework (HW-01, HW-02).

Purpose: Enable teachers to create exercises and assign them to classes or individual students.
Output: Database schema, types, API routes for exercise management and assignment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-sprint-1-teacher-experience/01-RESEARCH.md
@.planning/phases/01-sprint-1-teacher-experience/01-02-SUMMARY.md

Key existing files:
@lib/supabase.ts (add types and functions)
@lib/sampleProblems.ts (reference for MathProblem interface)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create exercises database schema</name>
  <files>supabase/migrations/002_exercises.sql</files>
  <action>
Create `supabase/migrations/002_exercises.sql`:
```sql
-- Exercises table (teacher-created problems)
CREATE TABLE IF NOT EXISTS exercises (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  teacher_id UUID REFERENCES teachers(id) ON DELETE CASCADE NOT NULL,
  question TEXT NOT NULL,
  answer TEXT NOT NULL,
  difficulty INTEGER CHECK (difficulty BETWEEN 1 AND 5) DEFAULT 3,
  domain TEXT,
  grade INTEGER CHECK (grade BETWEEN 1 AND 6),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_exercises_teacher ON exercises(teacher_id);

-- Exercise assignments (to class or student)
CREATE TABLE IF NOT EXISTS exercise_assignments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  exercise_id UUID REFERENCES exercises(id) ON DELETE CASCADE NOT NULL,
  class_id UUID REFERENCES classes(id) ON DELETE CASCADE,
  student_id UUID REFERENCES students(id) ON DELETE CASCADE,
  due_date TIMESTAMPTZ,
  assigned_at TIMESTAMPTZ DEFAULT NOW(),
  -- Must have either class_id or student_id
  CONSTRAINT target_required CHECK (class_id IS NOT NULL OR student_id IS NOT NULL)
);

CREATE INDEX idx_assignments_exercise ON exercise_assignments(exercise_id);
CREATE INDEX idx_assignments_class ON exercise_assignments(class_id);
CREATE INDEX idx_assignments_student ON exercise_assignments(student_id);

-- RLS Policies
ALTER TABLE exercises ENABLE ROW LEVEL SECURITY;
ALTER TABLE exercise_assignments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Teachers manage own exercises" ON exercises
  FOR ALL USING (teacher_id = auth.uid());

CREATE POLICY "Service role bypass exercises" ON exercises
  FOR ALL USING (auth.jwt()->>'role' = 'service_role');

CREATE POLICY "Teachers manage exercise assignments" ON exercise_assignments
  FOR ALL USING (
    exercise_id IN (SELECT id FROM exercises WHERE teacher_id = auth.uid())
  );

CREATE POLICY "Service role bypass assignments" ON exercise_assignments
  FOR ALL USING (auth.jwt()->>'role' = 'service_role');
```

Run in Supabase SQL Editor after creating the file.
  </action>
  <verify>
1. Run migration in Supabase Dashboard > SQL Editor
2. Verify tables exist: `exercises`, `exercise_assignments`
3. Verify constraint: try inserting assignment with neither class_id nor student_id (should fail)
  </verify>
  <done>exercises and exercise_assignments tables created with proper constraints and RLS</done>
</task>

<task type="auto">
  <name>Task 2: Add Exercise types and functions to supabase.ts</name>
  <files>lib/supabase.ts</files>
  <action>
Add to lib/supabase.ts after the Class types and functions:

**Types (add after ClassWithStudents):**
```typescript
export interface Exercise {
  id: string
  teacher_id: string
  question: string
  answer: string
  difficulty: 1 | 2 | 3 | 4 | 5
  domain: string | null
  grade: 1 | 2 | 3 | 4 | 5 | 6 | null
  created_at: string
}

export interface ExerciseAssignment {
  id: string
  exercise_id: string
  class_id: string | null
  student_id: string | null
  due_date: string | null
  assigned_at: string
}
```

**Functions (add after class functions):**
```typescript
// =============================================================================
// EXERCISE FUNCTIONS
// =============================================================================

export async function getExercisesByTeacher(teacherId: string): Promise<Exercise[]> {
  const supabase = createServerSupabaseClient()
  const { data, error } = await supabase
    .from('exercises')
    .select('*')
    .eq('teacher_id', teacherId)
    .order('created_at', { ascending: false })

  if (error) {
    console.error('Error fetching exercises:', error)
    return []
  }
  return data || []
}

export async function createExercise(
  teacherId: string,
  question: string,
  answer: string,
  difficulty: 1 | 2 | 3 | 4 | 5 = 3,
  domain?: string,
  grade?: 1 | 2 | 3 | 4 | 5 | 6
): Promise<Exercise | null> {
  const supabase = createServerSupabaseClient()
  const { data, error } = await supabase
    .from('exercises')
    .insert({
      teacher_id: teacherId,
      question,
      answer,
      difficulty,
      domain: domain || null,
      grade: grade || null
    })
    .select()
    .single()

  if (error) {
    console.error('Error creating exercise:', error)
    return null
  }
  return data
}

export async function assignExerciseToClass(
  exerciseId: string,
  classId: string,
  dueDate?: string
): Promise<boolean> {
  const supabase = createServerSupabaseClient()
  const { error } = await supabase
    .from('exercise_assignments')
    .insert({
      exercise_id: exerciseId,
      class_id: classId,
      due_date: dueDate || null
    })

  if (error) {
    console.error('Error assigning to class:', error)
    return false
  }
  return true
}

export async function assignExerciseToStudents(
  exerciseId: string,
  studentIds: string[],
  dueDate?: string
): Promise<{ success: number; failed: number }> {
  const supabase = createServerSupabaseClient()
  let success = 0
  let failed = 0

  for (const studentId of studentIds) {
    const { error } = await supabase
      .from('exercise_assignments')
      .insert({
        exercise_id: exerciseId,
        student_id: studentId,
        due_date: dueDate || null
      })

    if (error) {
      console.error('Error assigning to student:', error)
      failed++
    } else {
      success++
    }
  }

  return { success, failed }
}

export async function getAssignmentsForStudent(studentId: string): Promise<Exercise[]> {
  const supabase = createServerSupabaseClient()

  // Get student's class IDs
  const { data: enrollments } = await supabase
    .from('class_students')
    .select('class_id')
    .eq('student_id', studentId)

  const classIds = enrollments?.map(e => e.class_id) || []

  // Get assignments for student directly or via class
  const { data: assignments, error } = await supabase
    .from('exercise_assignments')
    .select('exercise_id, exercises (*)')
    .or(`student_id.eq.${studentId},class_id.in.(${classIds.join(',')})`)

  if (error) {
    console.error('Error fetching assignments:', error)
    return []
  }

  // Extract unique exercises
  const exerciseMap = new Map<string, Exercise>()
  assignments?.forEach(a => {
    const ex = a.exercises as unknown as Exercise
    if (ex && !exerciseMap.has(ex.id)) {
      exerciseMap.set(ex.id, ex)
    }
  })

  return Array.from(exerciseMap.values())
}
```
  </action>
  <verify>
1. `npm run build` - no TypeScript errors
2. Types exported: Exercise, ExerciseAssignment
3. Functions exported: getExercisesByTeacher, createExercise, assignExerciseToClass, assignExerciseToStudents, getAssignmentsForStudent
  </verify>
  <done>Exercise types and CRUD/assignment functions added to lib/supabase.ts</done>
</task>

<task type="auto">
  <name>Task 3: Create exercise API routes</name>
  <files>
    app/api/exercises/route.ts
    app/api/exercises/assign/route.ts
  </files>
  <action>
**Create `app/api/exercises/route.ts`:**
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getExercisesByTeacher, createExercise } from '@/lib/supabase'

export async function GET(request: NextRequest) {
  const teacherId = request.headers.get('x-teacher-id')
  if (!teacherId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const exercises = await getExercisesByTeacher(teacherId)
  return NextResponse.json({ exercises })
}

export async function POST(request: NextRequest) {
  const { teacherId, question, answer, difficulty, domain, grade } = await request.json()

  if (!teacherId || !question || !answer) {
    return NextResponse.json(
      { error: 'Teacher ID, question, and answer required' },
      { status: 400 }
    )
  }

  const exercise = await createExercise(
    teacherId,
    question,
    answer,
    difficulty || 3,
    domain,
    grade
  )

  if (!exercise) {
    return NextResponse.json({ error: 'Failed to create exercise' }, { status: 500 })
  }

  return NextResponse.json({ exercise })
}
```

**Create `app/api/exercises/assign/route.ts`:**
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { assignExerciseToClass, assignExerciseToStudents } from '@/lib/supabase'

export async function POST(request: NextRequest) {
  const { exerciseId, classId, studentIds, dueDate } = await request.json()

  if (!exerciseId) {
    return NextResponse.json({ error: 'Exercise ID required' }, { status: 400 })
  }

  if (!classId && (!studentIds || studentIds.length === 0)) {
    return NextResponse.json(
      { error: 'Must provide classId or studentIds' },
      { status: 400 }
    )
  }

  // Assign to class
  if (classId) {
    const success = await assignExerciseToClass(exerciseId, classId, dueDate)
    if (!success) {
      return NextResponse.json({ error: 'Failed to assign to class' }, { status: 500 })
    }
    return NextResponse.json({ success: true, assignedTo: 'class' })
  }

  // Assign to specific students
  if (studentIds && studentIds.length > 0) {
    const result = await assignExerciseToStudents(exerciseId, studentIds, dueDate)
    return NextResponse.json({
      success: true,
      assignedTo: 'students',
      ...result
    })
  }

  return NextResponse.json({ error: 'No assignment target' }, { status: 400 })
}
```
  </action>
  <verify>
1. `npm run build` - no errors
2. API routes exist:
   - app/api/exercises/route.ts
   - app/api/exercises/assign/route.ts
3. Test with curl:
   - POST /api/exercises with question/answer creates exercise
   - POST /api/exercises/assign with exerciseId + classId creates assignment
  </verify>
  <done>Exercise CRUD and assignment API routes created</done>
</task>

</tasks>

<verification>
- [ ] Migration applied: exercises and exercise_assignments tables exist
- [ ] Types: Exercise, ExerciseAssignment in lib/supabase.ts
- [ ] Functions: getExercisesByTeacher, createExercise, assignExerciseToClass, assignExerciseToStudents
- [ ] GET/POST /api/exercises works
- [ ] POST /api/exercises/assign works with classId or studentIds
- [ ] Build passes: `npm run build`
</verification>

<success_criteria>
1. Teacher can create exercise via API
2. Exercise can be assigned to class (HW-01 partial)
3. Exercise can be assigned to specific students (HW-02)
4. Database constraint ensures assignment has target
</success_criteria>

<output>
After completion, create `.planning/phases/01-sprint-1-teacher-experience/01-05-SUMMARY.md`
</output>
