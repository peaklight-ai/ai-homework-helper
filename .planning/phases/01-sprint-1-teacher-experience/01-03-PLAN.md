---
phase: 01-sprint-1-teacher-experience
plan: 03
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - components/ClassSelector.tsx
  - components/CSVImportModal.tsx
  - lib/csv-validation.ts
  - app/api/classes/[id]/import/route.ts
autonomous: true

must_haves:
  truths:
    - "Teacher can select a class from dropdown to filter student view"
    - "Teacher can upload CSV file with student data"
    - "CSV shows preview with valid/invalid rows before import"
    - "Invalid rows show specific error messages"
    - "Valid students are created and enrolled in selected class"
  artifacts:
    - path: "components/ClassSelector.tsx"
      provides: "Class dropdown/tabs for filtering"
      min_lines: 30
    - path: "components/CSVImportModal.tsx"
      provides: "CSV upload with preview and validation"
      min_lines: 80
    - path: "lib/csv-validation.ts"
      provides: "Zod schema for CSV row validation"
      contains: "StudentRowSchema"
    - path: "app/api/classes/[id]/import/route.ts"
      provides: "Bulk import endpoint"
      exports: ["POST"]
  key_links:
    - from: "components/CSVImportModal.tsx"
      to: "lib/csv-validation.ts"
      via: "import StudentRowSchema"
      pattern: "StudentRowSchema"
    - from: "components/CSVImportModal.tsx"
      to: "/api/classes/[id]/import"
      via: "fetch POST"
      pattern: "fetch.*api/classes.*import"
---

<objective>
Build class selection UI and CSV bulk import functionality.

Purpose: Enable teachers to organize students by class and efficiently import student lists from spreadsheets.
Output: ClassSelector component, CSVImportModal with validation, and bulk import API endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-sprint-1-teacher-experience/01-RESEARCH.md
@.planning/phases/01-sprint-1-teacher-experience/01-01-SUMMARY.md

Key existing files:
@app/teacher/page.tsx (teacher dashboard - study styling patterns)
@lib/supabase.ts (types and functions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV validation schema</name>
  <files>lib/csv-validation.ts</files>
  <action>
Create `lib/csv-validation.ts`:
```typescript
import { z } from 'zod'

// CSV row schema - minimal fields only
export const StudentRowSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  grade: z.coerce.number().int().min(1, 'Grade must be 1-6').max(6, 'Grade must be 1-6'),
})

export type StudentRow = z.infer<typeof StudentRowSchema>

// Header normalization - handle common variations
export function normalizeHeader(header: string): string {
  const normalized = header.toLowerCase().trim().replace(/\s+/g, '_')
  const aliases: Record<string, string> = {
    'student_name': 'name',
    'student': 'name',
    'full_name': 'name',
    'grade_level': 'grade',
    'class': 'grade',
    'year': 'grade',
  }
  return aliases[normalized] || normalized
}

// Parse result type
export interface ParsedRow {
  rowNumber: number
  data: Record<string, unknown>
  valid: boolean
  student?: StudentRow
  errors: string[]
}
```

Note: Using Zod for validation (already in project dependencies from form validation). This is minimal - just name and grade, no extra fields per user constraint.
  </action>
  <verify>
1. `npm run build` - no TypeScript errors
2. File exports: StudentRowSchema, StudentRow, normalizeHeader, ParsedRow
  </verify>
  <done>CSV validation schema created with Zod for name/grade validation</done>
</task>

<task type="auto">
  <name>Task 2: Create ClassSelector and CSVImportModal components</name>
  <files>
    components/ClassSelector.tsx
    components/CSVImportModal.tsx
  </files>
  <action>
**First, install dependencies:**
```bash
npm install papaparse react-dropzone
npm install -D @types/papaparse
```

**Create `components/ClassSelector.tsx`:**
```typescript
'use client'

import { ClassWithStudents } from '@/lib/supabase'

interface ClassSelectorProps {
  classes: ClassWithStudents[]
  selectedClassId: string | null
  onSelectClass: (classId: string | null) => void
  onCreateClass: () => void
}

export function ClassSelector({
  classes,
  selectedClassId,
  onSelectClass,
  onCreateClass
}: ClassSelectorProps) {
  return (
    <div className="flex items-center gap-2 mb-4">
      <select
        value={selectedClassId || ''}
        onChange={(e) => onSelectClass(e.target.value || null)}
        className="flex-1 px-3 py-2 rounded-lg focus:outline-none focus:ring-2"
        style={{
          backgroundColor: '#1E293B',
          color: '#F9FAFB',
          border: '1px solid #38BDF8'
        }}
      >
        <option value="">All Students</option>
        {classes.map((c) => (
          <option key={c.id} value={c.id}>
            {c.name} ({c.studentCount} students)
          </option>
        ))}
      </select>
      <button
        onClick={onCreateClass}
        className="px-3 py-2 rounded-lg font-medium transition-all hover:scale-105"
        style={{ backgroundColor: '#38BDF8', color: '#020617' }}
      >
        + Class
      </button>
    </div>
  )
}
```

**Create `components/CSVImportModal.tsx`:**
```typescript
'use client'

import { useCallback, useState } from 'react'
import { useDropzone } from 'react-dropzone'
import Papa from 'papaparse'
import { motion } from 'framer-motion'
import { StudentRowSchema, normalizeHeader, ParsedRow } from '@/lib/csv-validation'

interface CSVImportModalProps {
  classId: string
  className: string
  onClose: () => void
  onImportComplete: () => void
}

export function CSVImportModal({
  classId,
  className,
  onClose,
  onImportComplete
}: CSVImportModalProps) {
  const [parsedRows, setParsedRows] = useState<ParsedRow[]>([])
  const [isImporting, setIsImporting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const onDrop = useCallback((acceptedFiles: File[]) => {
    const file = acceptedFiles[0]
    if (!file) return

    setError(null)
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      transformHeader: normalizeHeader,
      complete: (results) => {
        const validated = results.data.map((row, index) => {
          const result = StudentRowSchema.safeParse(row)
          return {
            rowNumber: index + 2, // +2 for header + 1-indexing
            data: row as Record<string, unknown>,
            valid: result.success,
            student: result.success ? result.data : undefined,
            errors: result.success ? [] : result.error.errors.map(e => e.message)
          }
        })
        setParsedRows(validated)
      },
      error: (err) => {
        setError(`Failed to parse CSV: ${err.message}`)
      }
    })
  }, [])

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: { 'text/csv': ['.csv'] },
    maxFiles: 1
  })

  const validRows = parsedRows.filter(r => r.valid)
  const invalidRows = parsedRows.filter(r => !r.valid)

  const handleImport = async () => {
    if (validRows.length === 0) return

    setIsImporting(true)
    setError(null)
    try {
      const response = await fetch(`/api/classes/${classId}/import`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          students: validRows.map(r => r.student)
        })
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'Import failed')
      }

      onImportComplete()
      onClose()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Import failed')
    } finally {
      setIsImporting(false)
    }
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <motion.div
        className="w-full max-w-lg mx-4 rounded-xl p-6 max-h-[80vh] overflow-y-auto"
        style={{ backgroundColor: '#0F172A', border: '1px solid #1E293B' }}
        initial={{ opacity: 0, scale: 0.9 }}
        animate={{ opacity: 1, scale: 1 }}
      >
        <h2 className="text-xl font-bold mb-2" style={{ color: '#F9FAFB' }}>
          Import Students to {className}
        </h2>
        <p className="text-sm mb-4" style={{ color: '#94A3B8' }}>
          Upload a CSV file with columns: name, grade
        </p>

        {/* Error message */}
        {error && (
          <div
            className="mb-4 p-3 rounded-lg"
            style={{ backgroundColor: 'rgba(251, 113, 133, 0.1)', border: '1px solid #FB7185' }}
          >
            <p style={{ color: '#FB7185' }}>{error}</p>
          </div>
        )}

        {/* Dropzone */}
        <div
          {...getRootProps()}
          className="p-8 rounded-lg border-2 border-dashed cursor-pointer transition-all mb-4"
          style={{
            backgroundColor: isDragActive ? 'rgba(56, 189, 248, 0.1)' : '#1E293B',
            borderColor: isDragActive ? '#38BDF8' : '#64748B'
          }}
        >
          <input {...getInputProps()} />
          <p className="text-center" style={{ color: '#94A3B8' }}>
            {isDragActive
              ? 'Drop the CSV file here...'
              : 'Drag & drop a CSV file, or click to select'}
          </p>
        </div>

        {/* Preview */}
        {parsedRows.length > 0 && (
          <div className="mb-4">
            <div className="flex gap-4 mb-3">
              <p style={{ color: '#22C55E' }}>{validRows.length} valid</p>
              {invalidRows.length > 0 && (
                <p style={{ color: '#FB7185' }}>{invalidRows.length} invalid</p>
              )}
            </div>

            {/* Show invalid rows with errors */}
            {invalidRows.length > 0 && (
              <div className="space-y-2 max-h-32 overflow-y-auto">
                {invalidRows.map(row => (
                  <div
                    key={row.rowNumber}
                    className="p-2 rounded text-sm"
                    style={{ backgroundColor: 'rgba(251, 113, 133, 0.1)' }}
                  >
                    <span style={{ color: '#FB7185' }}>Row {row.rowNumber}:</span>{' '}
                    <span style={{ color: '#94A3B8' }}>{row.errors.join(', ')}</span>
                  </div>
                ))}
              </div>
            )}

            {/* Show valid preview (first 5) */}
            {validRows.length > 0 && (
              <div className="mt-3">
                <p className="text-xs mb-2" style={{ color: '#64748B' }}>Preview:</p>
                <div className="space-y-1">
                  {validRows.slice(0, 5).map(row => (
                    <div key={row.rowNumber} className="text-sm" style={{ color: '#F9FAFB' }}>
                      {row.student?.name} (Grade {row.student?.grade})
                    </div>
                  ))}
                  {validRows.length > 5 && (
                    <p className="text-xs" style={{ color: '#64748B' }}>
                      ...and {validRows.length - 5} more
                    </p>
                  )}
                </div>
              </div>
            )}
          </div>
        )}

        {/* Actions */}
        <div className="flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 py-2 rounded-lg font-medium"
            style={{ backgroundColor: '#1E293B', color: '#94A3B8' }}
          >
            Cancel
          </button>
          <button
            onClick={handleImport}
            disabled={validRows.length === 0 || isImporting}
            className="flex-1 py-2 rounded-lg font-medium disabled:opacity-50"
            style={{ backgroundColor: '#22C55E', color: '#020617' }}
          >
            {isImporting ? 'Importing...' : `Import ${validRows.length} Students`}
          </button>
        </div>

        {/* Template download link */}
        <p className="text-center text-xs mt-4" style={{ color: '#64748B' }}>
          Need a template?{' '}
          <a
            href="/templates/student-import.csv"
            download
            className="underline"
            style={{ color: '#38BDF8' }}
          >
            Download CSV template
          </a>
        </p>
      </motion.div>
    </div>
  )
}
```
  </action>
  <verify>
1. Dependencies installed: check package.json for papaparse, react-dropzone
2. `npm run build` - no errors
3. Files exist: components/ClassSelector.tsx, components/CSVImportModal.tsx
  </verify>
  <done>ClassSelector dropdown and CSVImportModal with validation preview created</done>
</task>

<task type="auto">
  <name>Task 3: Create bulk import API endpoint and CSV template</name>
  <files>
    app/api/classes/[id]/import/route.ts
    public/templates/student-import.csv
  </files>
  <action>
**Create `app/api/classes/[id]/import/route.ts`:**
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createServerSupabaseClient, generateLoginCode, enrollStudent } from '@/lib/supabase'

interface ImportStudent {
  name: string
  grade: number
}

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id: classId } = await params
  const { students } = await request.json() as { students: ImportStudent[] }

  if (!students || !Array.isArray(students) || students.length === 0) {
    return NextResponse.json({ error: 'No students to import' }, { status: 400 })
  }

  const supabase = createServerSupabaseClient()

  // Get class to find teacher_id
  const { data: classData, error: classError } = await supabase
    .from('classes')
    .select('teacher_id')
    .eq('id', classId)
    .single()

  if (classError || !classData) {
    return NextResponse.json({ error: 'Class not found' }, { status: 404 })
  }

  const results = {
    imported: 0,
    failed: 0,
    errors: [] as Array<{ name: string; error: string }>
  }

  // Import each student
  for (const student of students) {
    const loginCode = generateLoginCode()
    const avatarSeed = `${student.name}-${Date.now()}-${Math.random()}`

    // Create student
    const { data: newStudent, error: studentError } = await supabase
      .from('students')
      .insert({
        teacher_id: classData.teacher_id,
        name: student.name,
        grade: student.grade,
        avatar_seed: avatarSeed,
        login_code: loginCode
      })
      .select()
      .single()

    if (studentError) {
      results.failed++
      results.errors.push({ name: student.name, error: studentError.message })
      continue
    }

    // Create progress record
    await supabase.from('progress').insert({
      student_id: newStudent.id,
      total_xp: 0,
      level: 1,
      current_streak: 0,
      longest_streak: 0,
      total_questions: 0,
      correct_answers: 0
    })

    // Create settings record
    await supabase.from('student_settings').insert({
      student_id: newStudent.id,
      allowed_topics: ['addition', 'subtraction', 'multiplication', 'division'],
      difficulty_level: Math.min(student.grade, 5)
    })

    // Enroll in class
    await enrollStudent(classId, newStudent.id)

    results.imported++
  }

  return NextResponse.json(results)
}
```

**Create `public/templates/student-import.csv`:**
```csv
name,grade
John Smith,3
Jane Doe,3
Alex Johnson,4
```
  </action>
  <verify>
1. `npm run build` - no errors
2. API route exists: app/api/classes/[id]/import/route.ts
3. Template downloadable: http://localhost:3000/templates/student-import.csv
  </verify>
  <done>Bulk import API endpoint creates students, progress, settings, and enrollment records. CSV template available for download.</done>
</task>

</tasks>

<verification>
- [ ] Dependencies: papaparse, react-dropzone in package.json
- [ ] lib/csv-validation.ts exports StudentRowSchema
- [ ] components/ClassSelector.tsx renders class dropdown
- [ ] components/CSVImportModal.tsx handles file drop, validation, import
- [ ] POST /api/classes/[id]/import creates students and enrolls them
- [ ] CSV template downloadable at /templates/student-import.csv
- [ ] Build passes: `npm run build`
</verification>

<success_criteria>
1. CSV file with name,grade columns can be uploaded
2. Preview shows valid/invalid rows with error messages
3. Valid students created and enrolled in class
4. Components follow existing dashboard styling patterns
</success_criteria>

<output>
After completion, create `.planning/phases/01-sprint-1-teacher-experience/01-03-SUMMARY.md`
</output>
