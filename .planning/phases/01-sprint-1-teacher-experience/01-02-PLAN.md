---
phase: 01-sprint-1-teacher-experience
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - lib/supabase.ts
  - app/api/classes/route.ts
  - app/api/classes/[id]/route.ts
  - app/api/classes/[id]/students/route.ts
autonomous: true

must_haves:
  truths:
    - "Teacher can create a new class with name and grade"
    - "Teacher can view list of their classes"
    - "Teacher can update class name"
    - "Teacher can delete a class"
    - "Teacher can enroll/unenroll students from a class"
  artifacts:
    - path: "lib/supabase.ts"
      provides: "Class and ClassStudent types, CRUD functions"
      contains: "interface Class"
    - path: "app/api/classes/route.ts"
      provides: "GET (list) and POST (create) class endpoints"
      exports: ["GET", "POST"]
    - path: "app/api/classes/[id]/route.ts"
      provides: "GET, PUT, DELETE for single class"
      exports: ["GET", "PUT", "DELETE"]
    - path: "app/api/classes/[id]/students/route.ts"
      provides: "POST (enroll) and DELETE (unenroll) student endpoints"
      exports: ["POST", "DELETE"]
  key_links:
    - from: "app/api/classes/route.ts"
      to: "lib/supabase.ts"
      via: "createServerSupabaseClient"
      pattern: "createServerSupabaseClient"
    - from: "app/api/classes/[id]/students/route.ts"
      to: "class_students table"
      via: "Supabase client"
      pattern: "from\\('class_students'\\)"
---

<objective>
Build class management API layer with TypeScript types and CRUD operations.

Purpose: Enable teachers to create, read, update, and delete classes, and manage student enrollment.
Output: Complete API routes for class management ready for UI consumption.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-sprint-1-teacher-experience/01-RESEARCH.md
@.planning/phases/01-sprint-1-teacher-experience/01-01-SUMMARY.md

Key existing files:
@lib/supabase.ts (add types and functions here)
@app/api/students/route.ts (follow this pattern for API routes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Class types and Supabase functions</name>
  <files>lib/supabase.ts</files>
  <action>
Add to lib/supabase.ts after the existing type definitions (around line 75):

**Types:**
```typescript
export interface Class {
  id: string
  teacher_id: string
  name: string
  grade: 1 | 2 | 3 | 4 | 5 | 6 | null
  created_at: string
}

export interface ClassStudent {
  id: string
  class_id: string
  student_id: string
  enrolled_at: string
}

export interface ClassWithStudents extends Class {
  studentCount: number
  students: Student[]
}
```

**Functions (add after existing CRUD functions):**
```typescript
// =============================================================================
// CLASS FUNCTIONS
// =============================================================================

export async function getClassesByTeacher(teacherId: string): Promise<ClassWithStudents[]> {
  const supabase = createServerSupabaseClient()
  const { data, error } = await supabase
    .from('classes')
    .select(`
      *,
      class_students (
        student_id,
        students (id, name, grade, avatar_seed, login_code)
      )
    `)
    .eq('teacher_id', teacherId)
    .order('created_at', { ascending: false })

  if (error) {
    console.error('Error fetching classes:', error)
    return []
  }

  return (data || []).map(c => ({
    ...c,
    studentCount: c.class_students?.length || 0,
    students: c.class_students?.map((cs: { students: Student }) => cs.students).filter(Boolean) || []
  }))
}

export async function createClass(
  teacherId: string,
  name: string,
  grade?: 1 | 2 | 3 | 4 | 5 | 6
): Promise<Class | null> {
  const supabase = createServerSupabaseClient()
  const { data, error } = await supabase
    .from('classes')
    .insert({ teacher_id: teacherId, name, grade })
    .select()
    .single()

  if (error) {
    console.error('Error creating class:', error)
    return null
  }
  return data
}

export async function updateClass(
  classId: string,
  updates: { name?: string; grade?: 1 | 2 | 3 | 4 | 5 | 6 }
): Promise<boolean> {
  const supabase = createServerSupabaseClient()
  const { error } = await supabase
    .from('classes')
    .update(updates)
    .eq('id', classId)

  if (error) {
    console.error('Error updating class:', error)
    return false
  }
  return true
}

export async function deleteClass(classId: string): Promise<boolean> {
  const supabase = createServerSupabaseClient()
  const { error } = await supabase
    .from('classes')
    .delete()
    .eq('id', classId)

  if (error) {
    console.error('Error deleting class:', error)
    return false
  }
  return true
}

export async function enrollStudent(classId: string, studentId: string): Promise<boolean> {
  const supabase = createServerSupabaseClient()
  const { error } = await supabase
    .from('class_students')
    .insert({ class_id: classId, student_id: studentId })

  if (error) {
    console.error('Error enrolling student:', error)
    return false
  }
  return true
}

export async function unenrollStudent(classId: string, studentId: string): Promise<boolean> {
  const supabase = createServerSupabaseClient()
  const { error } = await supabase
    .from('class_students')
    .delete()
    .eq('class_id', classId)
    .eq('student_id', studentId)

  if (error) {
    console.error('Error unenrolling student:', error)
    return false
  }
  return true
}

export async function getStudentsByClass(classId: string): Promise<Student[]> {
  const supabase = createServerSupabaseClient()
  const { data, error } = await supabase
    .from('class_students')
    .select('students (*)')
    .eq('class_id', classId)

  if (error) {
    console.error('Error fetching class students:', error)
    return []
  }

  return (data || []).map((cs: { students: Student }) => cs.students).filter(Boolean)
}
```
  </action>
  <verify>
1. `npm run build` - no TypeScript errors
2. Types export correctly: search file for "export interface Class"
  </verify>
  <done>Class/ClassStudent types and CRUD functions added to lib/supabase.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create class API routes (list, create, update, delete)</name>
  <files>
    app/api/classes/route.ts
    app/api/classes/[id]/route.ts
  </files>
  <action>
Create `app/api/classes/route.ts`:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getClassesByTeacher, createClass } from '@/lib/supabase'

export async function GET(request: NextRequest) {
  const teacherId = request.headers.get('x-teacher-id')
  if (!teacherId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const classes = await getClassesByTeacher(teacherId)
  return NextResponse.json({ classes })
}

export async function POST(request: NextRequest) {
  const { teacherId, name, grade } = await request.json()

  if (!teacherId || !name) {
    return NextResponse.json({ error: 'Teacher ID and name required' }, { status: 400 })
  }

  const newClass = await createClass(teacherId, name, grade)
  if (!newClass) {
    return NextResponse.json({ error: 'Failed to create class' }, { status: 500 })
  }

  return NextResponse.json({ class: newClass })
}
```

Create `app/api/classes/[id]/route.ts`:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { updateClass, deleteClass } from '@/lib/supabase'

export async function PUT(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params
  const { name, grade } = await request.json()

  const success = await updateClass(id, { name, grade })
  if (!success) {
    return NextResponse.json({ error: 'Failed to update class' }, { status: 500 })
  }

  return NextResponse.json({ success: true })
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params

  const success = await deleteClass(id)
  if (!success) {
    return NextResponse.json({ error: 'Failed to delete class' }, { status: 500 })
  }

  return NextResponse.json({ success: true })
}
```

Note: Using `params: Promise<{ id: string }>` which is the Next.js 15+ pattern for dynamic route params.
  </action>
  <verify>
1. `npm run build` - no errors
2. Directory structure: `app/api/classes/route.ts` and `app/api/classes/[id]/route.ts` exist
  </verify>
  <done>Class CRUD API routes created for list, create, update, delete operations</done>
</task>

<task type="auto">
  <name>Task 3: Create student enrollment API route</name>
  <files>app/api/classes/[id]/students/route.ts</files>
  <action>
Create `app/api/classes/[id]/students/route.ts`:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { enrollStudent, unenrollStudent, getStudentsByClass } from '@/lib/supabase'

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id: classId } = await params

  const students = await getStudentsByClass(classId)
  return NextResponse.json({ students })
}

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id: classId } = await params
  const { studentId } = await request.json()

  if (!studentId) {
    return NextResponse.json({ error: 'Student ID required' }, { status: 400 })
  }

  const success = await enrollStudent(classId, studentId)
  if (!success) {
    return NextResponse.json({ error: 'Failed to enroll student' }, { status: 500 })
  }

  return NextResponse.json({ success: true })
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id: classId } = await params
  const { searchParams } = new URL(request.url)
  const studentId = searchParams.get('studentId')

  if (!studentId) {
    return NextResponse.json({ error: 'Student ID required' }, { status: 400 })
  }

  const success = await unenrollStudent(classId, studentId)
  if (!success) {
    return NextResponse.json({ error: 'Failed to unenroll student' }, { status: 500 })
  }

  return NextResponse.json({ success: true })
}
```
  </action>
  <verify>
1. `npm run build` - no errors
2. File exists at `app/api/classes/[id]/students/route.ts`
3. Test with curl (after running dev server):
   - `curl -X GET http://localhost:3000/api/classes -H "x-teacher-id: [id]"` returns classes array
  </verify>
  <done>Student enrollment API routes created for GET, POST (enroll), DELETE (unenroll)</done>
</task>

</tasks>

<verification>
- [ ] Types added: `Class`, `ClassStudent`, `ClassWithStudents` in lib/supabase.ts
- [ ] Functions added: getClassesByTeacher, createClass, updateClass, deleteClass, enrollStudent, unenrollStudent
- [ ] API routes exist:
  - [ ] GET/POST /api/classes
  - [ ] PUT/DELETE /api/classes/[id]
  - [ ] GET/POST/DELETE /api/classes/[id]/students
- [ ] Build passes: `npm run build`
</verification>

<success_criteria>
1. All TypeScript types compile without errors
2. All API routes accessible (build succeeds)
3. Pattern follows existing /api/students route structure
</success_criteria>

<output>
After completion, create `.planning/phases/01-sprint-1-teacher-experience/01-02-SUMMARY.md`
</output>
